尺寸统一 + 白底不失控。最小可行解按这套做就行：

固定三件套（写死）

WHITE_THR = 245（近白阈值）

ROW/COL_WHITE_RATIO = 0.95（整行/整列算空白）

MIN_BAND = 80px（小于这高度/宽度的不裁）

破局方法（一步到位）

先裁再缩

对每张图：找“空白带”（行/列满足 0.95 且 ≥80px），只裁最外层的上/下/左/右大白带，各保留 SAFE_MARGIN=30px。

若裁完短边 < 256px 或总尺寸被砍 >30% ⇒ 回滚（说明这图本来就小/浅底）。

统一输出尺寸，用“定宽 + 固定比例”

设目标：W_out=1080，R=9:16 ⇒ H_target= round(W_out*16/9)=1920。

把两张图等比缩放到相同宽度 W_out（高度各自变）。

上下合成，中间 gap=40px ⇒ 得到 H_out = H1+gap+H2。

若 H_out < H_target ⇒ 上下加白边补到 H_target。

若 H_out > H_target ⇒ 先把 gap 压到 0；仍超 ⇒ 同比缩小两图直到 H_out=H_target（保持 W_out 不变）。

极端比例兜底

仍超出很多（缩到两图总高 < 0.75*H_target） ⇒ 提高 W_out 一档（如 1080→1242），重算步骤2。

防主体误裁：任何时候都不裁中间白带，只裁边缘带；裁后再居中。

实施记录：
- `processImage` 上传阶段即执行白带裁剪，按 `WHITE_THR=245`、`ROW/COL_WHITE_RATIO=0.95`、`MIN_BAND=80`、`SAFE_MARGIN=30` 自动剔除外层大白带，小图或裁量超过 30% 会回滚原图。
- 合成逻辑固定输出 1080×1920（必要时升级到 1242×2208），按照“白顶 → 封面 → 间隔 → 效果 → 白底”排布；高度不足时补白，高度过高先压 gap 后同比缩放并自动左右留白。
- 预览区与导出共用同一排版计划，滑杆调整 gap 即时反映在预览和最终长图中，确保手机/桌面看到的效果一致。

最短伪代码
# per image
img = smart_trim(img, thr=245, row_ratio=0.95, col_ratio=0.95,
                 min_band=80, safe_margin=30, rollback_if_too_much=True)

# compose
W_out, R = 1080, 9/16
H_target = round(W_out / R)

A = resize_to_width(imgA, W_out)
B = resize_to_width(imgB, W_out)
gap = 40
H_out = A.h + gap + B.h

if H_out < H_target:
    pad_top_bottom((H_target - H_out)//2)  # 居中补白
else:
    gap = max(0, gap - (H_out - H_target))
    H_out = A.h + gap + B.h
    if H_out > H_target:
        scale = H_target / H_out
        A = resize(A, scale); B = resize(B, scale)
# 得到 1080×1920 的稳定输出


核心就这两点：先裁边缘大白带，再用“定宽 + 固定高宽比”强制落盘；超高就压 gap 和同比缩，偏矮就补白。这样 1:1、3:4、9:16 都能稳落 9:16（或任意你定的比例）
